<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.2.0/socket.io.js"></script>
    <title>Object Tracking</title>
</head>

<style>
    * {
        margin: 0;
        padding: 0;
    }

    .container {
        width: 80%;
        margin: auto;
    }

    .video-container {
        position: relative;
    }

    #overlay {
        border: 1px solid #000;
        width: 100%;
        height: 100%;

        position: absolute;
        top: 0;
        left: 0;
    }
</style>

<body>
    <div class="container">
        <h1>Object Tracking with Tensorflow</h1>
        <!-- <iframe width="420" height="315" src="https://www.youtube.com/embed/E8LsKcVpL5A?autoplay=1&mute=1"> -->
        <div class="video-container embed-responsive embed-responsive-16by9">
            <iframe class="embed-responsive-item" id="video-item"
                src="https://www.youtube.com/embed/E8LsKcVpL5A?autoplay=1&mute=1&controls=0"></iframe>
            <canvas id="overlay"></canvas>
        </div>
    </div>
</body>

<script>
    let socket;
    const overlay = document.getElementById("overlay");

    const drawBoundingBox = function (id, bboxCoords, className) {
        const ctx = overlay.getContext("2d");

        const x = parseInt(bboxCoords[0]);
        const y = parseInt(bboxCoords[1]);
        const width = parseInt(bboxCoords[2]);
        const height = parseInt(bboxCoords[3]);

        let color;

        switch (className) {
            case 'car':
                color = '#f03e3e';
            case 'truck':
                color = '#d6336c';
            case 'bus':
                color = '#ae3ec9';
            case 'motorcycle':
                color = '#7048e8';
            case 'bicycle':
                color = '#4263eb';
            case 'person':
                color = '#1098ad';
        }

        ctx.strokeRect(x, y, width, height);
        ctx.strokeStyle = color;
    }

    const clearCanvas = function () {
        const ctx = overlay.getContext("2d");
        ctx.clearRect(0, 0, overlay.width, overlay.height);
    }

    document.getElementById("video-item").addEventListener('load', function () {
        socket = io.connect("http://localhost:5000")

        socket.on("connect", function () {
            console.info("Socket Connected Successfully!");
        })

        socket.on("track", function (response) {
            clearCanvas();

            const resp = JSON.parse(response);
            const trackings = resp['trackings'];
            trackings.forEach(function (track) {
                // process the track to bring out the id, bbox and class name of this track
                const id = track['id'];
                const bboxCoords = track['bounding_box'];
                const className = track['class'];
                drawBoundingBox(id, bboxCoords, className);
            });
        });
    });
</script>

</html>